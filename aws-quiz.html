<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AWS Quiz</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
  /* Original styles preserved and integrated */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #e0f2ff, #f7faff);
    margin: 0; padding: 40px 20px 80px;
    color: #222;
    display: flex; justify-content: center; align-items: flex-start;
    min-height: 100vh;
  }
  .container {
    width: 100%; max-width: 980px;            /* widened so the grid can breathe */
    background: white; border-radius: 16px;
    box-shadow: 0 12px 40px rgba(0,123,255,0.2);
    padding: 3.1rem 2rem 3rem; box-sizing: border-box;
    user-select: none;
    position: relative;
  }
  #top-icons {
    position: absolute;
    top: 18px;
    right: 22px;
    display: flex;
    gap: 18px;
    z-index: 101;
  }
  #top-icons i {
    font-size: 1.8rem;
    color: #007bff;
    cursor: pointer;
    transition: color 0.3s;
  }
  #top-icons i:hover { color: #0056b3; }

  /* ---------- HOMEPAGE (decorated, non-breaking) ---------- */
  #chapter-select {
    text-align: center;
    margin-bottom: 3rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #007bff33;
  }
  #chapter-select h2 {
    font-size: 2.2rem;
    font-weight: 900;
    color: #007bff;
    margin: 0 0 0.3rem;
    letter-spacing: 2px;
    text-shadow: 0 2px 8px rgba(0,123,255,0.18);
  }
  #chapter-instruction {
    font-size: 1.05rem;
    color: #555d82;
    margin: 0 0 1.2rem;
    font-weight: 600;
  }
  /* Search bar wrapper */
  .search-wrap {
    display: flex; align-items: center; gap: 10px;
    max-width: 560px; margin: 0 auto 1.6rem;
    background: #fff; border: 1.5px solid #e2e8f0;
    border-radius: 999px; padding: 12px 16px;
    box-shadow: 0 8px 24px rgba(0, 123, 255, 0.08);
  }
  .search-wrap i { color: #7c3aed; font-size: 1rem; }
  #chapter-search {
    flex: 1; border: 0; outline: 0; font-size: 1rem; background: transparent;
  }

  /* Card grid for chapters */
  #chapter-list {
    list-style: none;
    padding: 0; margin: 0 auto;
    max-width: 900px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 18px;
  }
  /* Each chapter tile remains an <li> so existing JS click handlers still work */
  #chapter-list li.chapter-card {
    background: #f0f6ff;
    border-radius: 18px;
    box-shadow: 0 10px 30px rgba(0,123,255,0.14);
    padding: 22px 18px;
    cursor: pointer;
    transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
    border: none;                        /* override old left border style */
    text-align: left;
  }
  #chapter-list li.chapter-card:hover {
    background: #ffffff;
    transform: translateY(-6px);
    box-shadow: 0 16px 40px rgba(0,123,255,0.22);
  }
  .chapter-card__name {
    font-size: 1.05rem; font-weight: 800; color: #0a56c2; margin-bottom: .35rem;
  }
  .chapter-card__count {
    font-size: .95rem; color: #5f6b7f; font-weight: 600;
  }
  /* Hide any legacy hover from old selector if present */
  #chapter-list li:hover,
  #chapter-list li:focus {
    border-left-color: transparent;
    color: inherit;
  }

  /* ---------- The rest of original quiz UI ---------- */
  #progress-bar {
    display: flex;
    align-items: center;
    margin-bottom: 1.1rem;
    gap: 14px;
    font-weight: 600;
    font-size: 1.13rem;
    color: #555;
  }
  .progress {
    flex: 1; height: 14px; border-radius: 8px;
    background: linear-gradient(90deg, #e9ecef, #f8f9fa);
    box-shadow: inset 0 1px 4px rgba(0,0,0,0.08);
    overflow: hidden; position: relative;
  }
  .progress-inner {
    background: linear-gradient(90deg, #28a745, #4bbf73);
    height: 100%; transition: width 0.35s; box-shadow: 0 2px 12px rgba(40,167,69,0.12);
    border-radius: 8px 0 0 8px;
  }
  #timer-display { font-weight: 700; font-size: 1.15rem; color: #dc3545; user-select: none; min-width: 110px; }

  #nav-bar { margin: 1.2rem 0 0.15rem 0; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-items: center; user-select: none; }
  .nav-btn {
    background: #e9ecef; border: none; border-radius: 50%; width: 38px; height: 38px;
    font-weight: 600; font-size: 1rem; cursor: pointer; color: #6c757d;
    box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    transition: background-color 0.23s, color 0.23s, box-shadow 0.23s; display: flex; align-items: center; justify-content: center;
  }
  .nav-btn:hover:not(.active) { background: #ced4da; color: #495057; box-shadow: 0 0 5px rgba(0,0,0,0.15); }
  .nav-btn.active { background: #007bff; color: white; box-shadow: 0 0 12px rgba(0,123,255,0.18); font-size: 1.05rem; font-weight: 700; }
  .nav-btn.answered-correct { background: #28a745; color: white; box-shadow: 0 0 8px rgba(40,167,69,0.11); }
  .nav-btn.answered-wrong { background: #dc3545; color: white; box-shadow: 0 0 8px rgba(220,53,69,0.12); }
  .nav-btn.current-wrong { border: 3px solid #a71d2a; box-shadow: 0 0 14px rgba(220,53,69,0.14); font-weight: 700; }

  #pagination-controls { display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 6px; user-select: none; font-weight: 600; color: #444; font-size: 0.97rem; }
  #pagination-controls button {
    cursor: pointer; border: 1.5px solid #ccc; background: #f0f0f0; padding: 6px 14px; border-radius: 7px; font-weight: 700; font-size: 1rem;
    transition: background-color 0.22s, border-color 0.22s; box-shadow: 0 2px 6px rgba(0,0,0,0.066);
  }
  #pagination-controls button:hover:not(:disabled) { background-color: #e1e7ef; border-color: #009; }
  #pagination-controls button:disabled { cursor: not-allowed; opacity: 0.58; }

  .question-container {
    margin-top: 2rem; margin-bottom: 1.5rem; border-radius: 12px; border: 1.5px solid #d8e0ec;
    background: #f9fbff; box-shadow: 0 4px 16px rgba(0,0,0,0.06);
    padding: 1.8rem 1.6rem; font-size: 1.12rem; line-height: 1.4; color: #222; user-select: none;
  }
  .question-container h2 { margin: 0 0 1.4rem 0; font-size: 1.5rem; font-weight: 700; color: #0056b3; }
  .options, .options li { list-style: none; padding: 0; margin: 0; }
  .options li {
    background: #fff; border: 2px solid #cdd4e0; border-radius: 8px; margin-bottom: 1rem; padding: 0.85rem 1.2rem;
    font-size: 1.15rem; cursor: pointer; transition: background-color 0.32s, border-color 0.32s; position: relative; user-select: none; box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }
  .options li:hover:not(.disabled) { background: #eaf4ff; border-color: #7aa7e9; box-shadow: 0 4px 14px rgba(122,167,233,0.14); }
  .options li.correct { border-color: #28a745; background-color: #d4edda; color: #155724; font-weight: 700; box-shadow: 0 0 16px rgba(40,167,69,0.22); }
  .options li.incorrect { border-color: #dc3545; background-color: #f8d7da; color: #721c24; font-weight: 700; box-shadow: 0 0 16px rgba(220,53,69,0.22); }
  .options li.disabled { cursor: not-allowed; opacity: 0.7; }
  .option-label { width: 40px; font-weight: 800; color: #007bff; }

  #action-buttons { text-align: center; }
  #action-buttons button {
    background: #007bff; color: white; font-weight: 700; font-size: 1.1rem; padding: 0.6rem 1.6rem; border-radius: 8px; border: none;
    cursor: pointer; margin: 1rem 10px 0 0; box-shadow: 0 5px 14px rgba(0,123,255,0.15); user-select: none; transition: background 0.26s;
  }
  #action-buttons button:disabled { background: #6c757d; cursor: not-allowed; box-shadow: none; }
  #action-buttons button:hover:not(:disabled) { background: #0056b3; }

  .explanation { background: #fff7d6; border: 1.5px solid #f7e498; padding: 1.2rem; margin-top: 1.4rem; border-radius: 10px; font-style: italic; min-height: 70px; color: #836d1f; box-shadow: 0 4px 12px rgba(247,228,152,0.19); }

  .scoreboard {
    background: #e8f0fe; border-radius: 18px; padding: 2.5rem 1rem 3rem 1rem; box-shadow: 0 6px 32px rgba(0,123,255,0.11);
    text-align: center; border: 3px solid #007bff; font-weight: 900; color: #00316c; max-width: 420px; margin: 3rem auto 0 auto;
  }
  .result-section { margin-bottom: 1.3rem; font-size: 1.25rem; }
  .result-success { color: #28a745; font-weight: 900; }
  .result-fail { color: #dc3545; font-weight: 900; }
  #result-chart { margin-top: 30px; max-width: 320px; margin-left: auto; margin-right: auto; }
  #result-chart img { max-width: 100%; box-shadow: 0 4px 18px rgba(40,167,69,0.06); border-radius: 16px; display: block; }

  #settings-modal {
    display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.09); justify-content: center; align-items: center; z-index: 1010; transition: opacity 0.15s;
  }
  #settings-content {
    background: white; border-radius: 13px; padding: 20px 30px; max-width: 320px; width: 90%; box-sizing: border-box; box-shadow: 0 4px 22px rgba(0,123,255,0.11);
  }
  #settings-content h3 { margin-top: 0; color: #007bff; font-weight: 900; margin-bottom: 20px; }
  #settings-content label { font-weight: 600; display: block; margin-bottom: 6px; }
  #settings-content select { width: 100%; padding: 8px; margin-bottom: 20px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; box-sizing: border-box; }
  #settings-actions { text-align: right; }
  #settings-actions button { margin-left: 8px; min-width: 75px; }

  /* Timer slider styles */
  .toggle-slider { position: relative; display: inline-block; width: 50px; height: 26px; }
  .toggle-slider input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 26px; }
  .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: #007bff; }
  input:checked + .slider:before { transform: translateX(24px); }
  select:disabled { background: #eee; color: #888; cursor: not-allowed; }

  /* Chapter intro card (unchanged) */
  #chapter-intro { display: none; text-align: center; padding: 2.5rem; user-select: none; }
  #chapter-intro h2 { font-size: 2rem; font-weight: 900; color: #25284c; letter-spacing: 1.2px; margin-bottom: 1rem; }
  #chapter-intro div { font-size: 1.2rem; color: #555d82; margin-bottom: 2.1rem; }
  #start-chapter-btn {
    background: #7b2ff7; color: white; font-weight: 700; font-size: 1.1rem; padding: 0.8rem 2.5rem; border-radius: 7px; border: none; cursor: pointer; box-shadow: 0 4px 16px rgba(123,47,247,0.12);
  }
  #start-chapter-btn:hover { background: #5901db; }
</style>
</head>
<body>
<div class="container">
  <div id="top-icons" title="Settings and Home">
    <i id="settings-icon" class="fa-solid fa-gear" title="Settings"></i>
    <i id="home-icon" class="fa-solid fa-house" title="Home"></i>
  </div>

  <!-- Chapter intro card for query param chapter -->
  <div id="chapter-intro">
    <h2 id="chapter-title">...</h2>
    <div id="chapter-question-count">...</div>
    <button id="start-chapter-btn">Start quiz</button>
  </div>

  <div id="chapter-select">
    <h2>Amazon Web Services Quiz</h2>
    <div id="chapter-instruction">Configure your quiz settings, then select a chapter below to begin testing your AWS knowledge!</div>

    <!-- NEW: Search bar (pure UI; doesn't affect logic) -->
    <div class="search-wrap">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input id="chapter-search" type="text" placeholder="Search chapters or scenarios..." />
    </div>

    <!-- Cards are still <li> so existing click logic works -->
    <ul id="chapter-list"></ul>
  </div>

  <div id="progress-bar" style="display:none;">
    <span id="progress-count"></span>
    <div class="progress"><div class="progress-inner"></div></div>
    <span id="timer-display" style="display:none;">Time left: <span id="timer-count">00:00</span></span>
  </div>
  <div id="nav-bar" style="display:none;"></div>
  <div id="pagination-controls" style="display:none;"></div>
  <div id="question-page" class="question-container" style="display:none;"></div>
  <div id="action-buttons" style="text-align:center;display:none;">
    <button id="prev-btn">Previous Question</button>
    <button id="next-btn" disabled>Next Question</button>
  </div>
  <div id="scoreboard" class="scoreboard" style="display:none;"></div>
</div>

<!-- Settings modal (unchanged) -->
<div id="settings-modal" aria-modal="true" role="dialog">
  <div id="settings-content">
    <h3>Quiz Settings</h3>
    <label for="max-questions-select">Max Questions (only before quiz start):</label>
    <select id="max-questions-select">
      <option value="10">10</option>
      <option value="20">20</option>
      <option value="50">50</option>
      <option value="100" selected>100</option>
      <option value="200">200</option>
      <option value="10000">All</option>
    </select>
    <label for="page-size-select">Questions Per Page (can update anytime):</label>
    <select id="page-size-select">
      <option value="5">5</option>
      <option value="10" selected>10</option>
      <option value="15">15</option>
      <option value="20">20</option>
    </select>
    <label for="timer-enable-slider" style="display:flex; align-items:center; gap: 12px; margin-top: 1.8rem; font-weight: 600;">
      <span>Enable Timer (only before quiz start):</span>
      <label class="toggle-slider">
        <input type="checkbox" id="timer-enable-slider">
        <span class="slider"></span>
      </label>
    </label>
    <label id="timer-duration-label" for="timer-duration-select" style="display:none; margin-top: 1rem; font-weight: 600;">
      Timer Duration Per Question:
    </label>
    <select id="timer-duration-select" style="display:none; margin-bottom: 1.8rem;">
      <option value="10">10 seconds</option>
      <option value="15">15 seconds</option>
      <option value="20">20 seconds</option>
      <option value="30">30 seconds</option>
      <option value="45">45 seconds</option>
      <option value="60">1 minute</option>
      <option value="90">1 min. 30 sec.</option>
      <option value="120" selected>2 minutes</option>
    </select>
    <div id="settings-actions">
      <button id="settings-save-btn" class="action-btn" style="background:#007bff; color: white;">Save</button>
      <button id="settings-cancel-btn" class="action-btn" style="background:#6c757d; color: white;">Cancel</button>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  let MAX_QUESTIONS = 100;
  let PAGE_SIZE = 10;
  let chapters = {};
  let questions = [];
  let currentIndex = 0;
  let answeredQuestions = [];
  let wrongQuestions = [];
  let selectedChapter = "";
  let currentPage = 0;
  let timerEnabled = false;
  let timerDuration = 120; // seconds
  let timerInterval = null;
  let timerRemaining = 0;

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }
  function getPerformanceCategory(scorePercent) {
    if (scorePercent >= 90) return "Excellent";
    if (scorePercent >= 75) return "Good";
    if (scorePercent >= 50) return "Fair";
    return "Needs Improvement";
  }

  /* ---- Renders the chapter list as CARDS + adds counts, without changing behavior ---- */
  function renderChapterList() {
    const $list = $("#chapter-list");
    $list.empty();

    const totalCount = Object.values(chapters).reduce((sum, arr) => sum + arr.length, 0);
    $list.append(`
      <li class="chapter-card" data-chapter="all">
        <div class="chapter-card__name"><strong>All Chapters</strong></div>
        <div class="chapter-card__count">${totalCount} questions</div>
      </li>
    `);

    Object.keys(chapters).forEach(chap => {
      const count = chapters[chap]?.length || 0;
      $list.append(`
        <li class="chapter-card" data-chapter="${chap}">
          <div class="chapter-card__name">${chap}</div>
          <div class="chapter-card__count">${count} questions</div>
        </li>
      `);
    });

    // Keep the exact same click behavior
    $list.find("li").on("click", function () {
      selectedChapter = $(this).data("chapter");
      startQuiz(selectedChapter === "all" ? "all" : selectedChapter);
      $("#chapter-select").hide();
    });

    // Search filter (purely visual)
    $("#chapter-search").off("input").on("input", function () {
      const q = $(this).val().toLowerCase();
      $("#chapter-list li").each(function () {
        const text = $(this).text().toLowerCase();
        $(this).toggle(text.includes(q));
      });
    });

    $("#max-questions-select").prop("disabled", selectedChapter !== "");
    $("#timer-enable-slider").prop("disabled", selectedChapter !== "");
    $("#timer-duration-select").prop("disabled", selectedChapter !== "");
  }

  function startQuiz(chapter) {
    if (chapter === "all") {
      questions = [];
      Object.values(chapters).forEach(arr => arr.forEach(q => questions.push({ ...q })));
    } else {
      questions = chapters[chapter].map(q => ({ ...q }));
    }
    if (questions.length > MAX_QUESTIONS) {
      questions = questions.slice(0, MAX_QUESTIONS);
    }
    shuffle(questions);
    answeredQuestions = new Array(questions.length).fill(false);
    wrongQuestions = new Array(questions.length).fill(false);
    currentIndex = 0;
    currentPage = 0;
    $("#progress-bar, #nav-bar, #pagination-controls, #question-page, #action-buttons").show();
    $("#scoreboard").hide();
    if (timerEnabled) {
      $("#timer-display").show();
      startTimer();
    } else {
      $("#timer-display").hide();
    }
    renderQuestion(currentIndex);
    renderNavBarPage(currentPage);
    renderPaginationControls();
  }

  function updateNavigationState() {
    if (timerEnabled) {
      $("#prev-btn").prop("disabled", true);
      $("#nav-bar button").off("click").on("click", function (e) { e.preventDefault(); });
      $("#pagination-controls button").prop("disabled", true);
    } else {
      $("#prev-btn").prop("disabled", currentIndex === 0);
      $("#nav-bar button").off("click").on("click", function () {
        let idx = Number($(this).attr("data-idx"));
        currentIndex = idx;
        currentPage = Math.floor(currentIndex / PAGE_SIZE);
        renderNavBarPage(currentPage);
        renderPaginationControls();
        renderQuestion(currentIndex);
        if (timerEnabled) { startTimer(); }
      });
      $("#pagination-controls button").prop("disabled", false);
    }
  }

  function renderNavBarPage(page) {
    const $nav = $("#nav-bar");
    $nav.empty();
    let start = page * PAGE_SIZE;
    let end = Math.min(start + PAGE_SIZE, questions.length);
    for (let i = start; i < end; i++) {
      let btnClass = "nav-btn";
      if (i === currentIndex) btnClass += " active";
      else if (!answeredQuestions[i]) btnClass += "";
      else if (wrongQuestions[i]) btnClass += " answered-wrong";
      else btnClass += " answered-correct";
      if (i === currentIndex && wrongQuestions[i]) btnClass += " current-wrong";
      $nav.append(`<button class="${btnClass}" data-idx="${i}">${i + 1}</button>`);
    }
    updateNavigationState();
  }

  function renderPaginationControls() {
    const $pagination = $("#pagination-controls");
    $pagination.empty();
    const totalPages = Math.ceil(questions.length / PAGE_SIZE);
    const isFirstPage = currentPage === 0;
    const isLastPage = currentPage === totalPages - 1;
    $pagination.append(`<button id="firstPage" ${isFirstPage ? "disabled" : ""}>First</button>`);
    $pagination.append(`<button id="prevPage" ${isFirstPage ? "disabled" : ""}>«</button>`);
    $pagination.append(`<span>Page ${currentPage + 1} of ${totalPages}</span>`);
    $pagination.append(`<button id="nextPage" ${isLastPage ? "disabled" : ""}>»</button>`);
    $pagination.append(`<button id="lastPage" ${isLastPage ? "disabled" : ""}>Last</button>`);
    $("#firstPage").off("click").on("click", () => {
      if (!isFirstPage) {
        currentPage = 0;
        renderNavBarPage(currentPage);
        renderPaginationControls();
        renderQuestion(currentPage * PAGE_SIZE);
        if (timerEnabled) startTimer();
      }
    });
    $("#prevPage").off("click").on("click", () => {
      if (!isFirstPage) {
        currentPage--;
        renderNavBarPage(currentPage);
        renderPaginationControls();
        renderQuestion(currentPage * PAGE_SIZE);
        if (timerEnabled) startTimer();
      }
    });
    $("#nextPage").off("click").on("click", () => {
      if (!isLastPage) {
        currentPage++;
        renderNavBarPage(currentPage);
        renderPaginationControls();
        renderQuestion(currentPage * PAGE_SIZE);
        if (timerEnabled) startTimer();
      }
    });
    $("#lastPage").off("click").on("click", () => {
      if (!isLastPage) {
        currentPage = totalPages - 1;
        renderNavBarPage(currentPage);
        renderPaginationControls();
        renderQuestion(currentPage * PAGE_SIZE);
        if (timerEnabled) startTimer();
      }
    });
    if (timerEnabled) { $("#pagination-controls button").prop("disabled", true); }
  }

  function renderQuestion(idx) {
    if (idx < 0) idx = 0;
    else if (idx >= questions.length) idx = questions.length - 1;
    currentIndex = idx;
    const q = questions[idx];
    const optionLabels = ["A", "B", "C", "D", "E"];
    let optionsHtml = "<ul class='options'>";
    optionLabels.forEach(label => {
      if (q[label]) {
        optionsHtml += `<li data-option="${label}"><span class="option-label">${label}.</span> ${q[label]}</li>`;
      }
    });
    optionsHtml += "</ul>";
    $("#question-page").html(`
      <h2>Question ${idx + 1}</h2>
      <div style="margin-bottom:1rem;font-size:1.07rem;">${q.Question}</div>
      ${optionsHtml}
      <div id="explanation" class="explanation" style="display:none;"></div>
    `);
    let numAnswered = answeredQuestions.filter(a => a).length;
    $("#progress-count").text(`Answered: ${numAnswered} / ${questions.length}`);
    $(".progress-inner").css("width", ((numAnswered / questions.length) * 100) + "%");
    if (timerEnabled) { $("#prev-btn").prop("disabled", true); }
    else { $("#prev-btn").prop("disabled", idx === 0); }
    $("#next-btn").text(idx === questions.length - 1 ? "Show Results" : "Next Question");
    $("#next-btn").prop("disabled", !answeredQuestions[idx]);
    if (!answeredQuestions[idx]) {
      $(".options li").removeClass("disabled correct incorrect");
      $(".options li").off("click").on("click", function () {
        handleAnswerSelection($(this), q, idx);
      });
    } else {
      showAnswerHighlight(q, idx);
      $(".options li").addClass("disabled");
    }
    updateNavigationState();
  }

  function handleAnswerSelection($li, question, idx) {
    if (answeredQuestions[idx]) return;
    const selected = $li.data("option");
    answeredQuestions[idx] = true;
    $(".options li").addClass("disabled");
    const $explanation = $("#explanation");
    $explanation.show();
    if (selected === question.Answer) {
      $li.addClass("correct");
      wrongQuestions[idx] = false;
      $explanation.html("<strong>Correct!</strong> " + question.Explanation);
    } else {
      $li.addClass("incorrect");
      wrongQuestions[idx] = true;
      $(".options li").each(function () {
        if ($(this).data("option") === question.Answer) {
          $(this).addClass("correct");
        }
      });
      $explanation.html("<strong>Incorrect.</strong> " + question.Explanation);
    }
    $("#next-btn").prop("disabled", false);
    renderNavBarPage(currentPage);
    let numAnswered = answeredQuestions.filter(a => a).length;
    $(".progress-inner").css("width", ((numAnswered / questions.length) * 100) + "%");
    $("#progress-count").text(`Answered: ${numAnswered} / ${questions.length}`);
    if (timerEnabled) { stopTimer(); }
  }

  function showAnswerHighlight(question, idx) {
    $(".options li").addClass("disabled");
    $(".options li").each(function () {
      if ($(this).data("option") === question.Answer) { $(this).addClass("correct"); }
    });
    $("#explanation").show().html("<strong>Explanation:</strong> " + question.Explanation);
  }

  $("#prev-btn").click(function () {
    if (timerEnabled) return;
    if (currentIndex > 0) {
      currentIndex--;
      let newPage = Math.floor(currentIndex / PAGE_SIZE);
      if (newPage !== currentPage) {
        currentPage = newPage;
        renderNavBarPage(currentPage);
        renderPaginationControls();
      }
      renderQuestion(currentIndex);
    }
  });

  $("#next-btn").click(function () {
    if (currentIndex < questions.length - 1) {
      currentIndex++;
      let newPage = Math.floor(currentIndex / PAGE_SIZE);
      if (newPage !== currentPage) {
        currentPage = newPage;
        renderNavBarPage(currentPage);
        renderPaginationControls();
      }
      renderQuestion(currentIndex);
      if (timerEnabled) { startTimer(); }
    } else {
      showFinalScore();
    }
  });

  function startTimer() {
    stopTimer();
    timerRemaining = timerDuration;
    updateTimerDisplay();
    timerInterval = setInterval(() => {
      timerRemaining--;
      updateTimerDisplay();
      if (timerRemaining <= 0) {
        stopTimer();
        if (!answeredQuestions[currentIndex]) {
          answeredQuestions[currentIndex] = true;
          wrongQuestions[currentIndex] = true;
          showAnswerHighlight(questions[currentIndex], currentIndex);
          $("#next-btn").prop("disabled", false);
          renderNavBarPage(currentPage);
          let numAnswered = answeredQuestions.filter(a => a).length;
          $(".progress-inner").css("width", ((numAnswered / questions.length) * 100) + "%");
          $("#progress-count").text(`Answered: ${numAnswered} / ${questions.length}`);
        }
        if (currentIndex < questions.length - 1) {
          currentIndex++;
          currentPage = Math.floor(currentIndex / PAGE_SIZE);
          renderNavBarPage(currentPage);
          renderPaginationControls();
          renderQuestion(currentIndex);
          startTimer();
        } else {
          showFinalScore();
        }
      }
    }, 1000);
  }
  function stopTimer() {
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    $("#timer-count").text(formatTime(0));
  }
  function updateTimerDisplay() { $("#timer-count").text(formatTime(timerRemaining)); }
  function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
  }

  function showFinalScore() {
    stopTimer();
    $("#question-page, #action-buttons, #nav-bar, #pagination-controls, #progress-bar").hide();
    let passed = 0, failed = 0, unanswered = 0;
    for (let i = 0; i < questions.length; i++) {
      if (!answeredQuestions[i]) unanswered++;
      else if (wrongQuestions[i]) failed++;
      else passed++;
    }
    let totalAnswered = passed + failed;
    let scorePercent = totalAnswered ? Math.round((passed / totalAnswered) * 100) : 0;
    let category = getPerformanceCategory(scorePercent);
    $("#scoreboard").show().html(`
      <div class="result-section" style="margin-bottom:1.7rem; font-size:1.4rem; font-weight:bold; color:#00316c;">
        Quiz Completed!
      </div>
      <div class="result-section" style="font-size:1.2rem;">
        You answered <strong>${passed}</strong> out of <strong>${questions.length}</strong> questions correctly.
      </div>
      <div class="result-section result-success" style="color:#28a745;">
        ${category} - ${scorePercent}%
      </div>
      <div class="result-section result-fail" style="color:#dc3545;">
        Wrong Answers: ${failed}
      </div>
      <div class="result-section" style="font-size:1.1rem;">
        Unanswered Questions: ${unanswered}
      </div>
      <div style="margin-top:2.8rem;">
        <button class="action-btn" style="background:#007bff;color:#fff;font-size:1.15rem;padding:0.7rem 2.2rem;border-radius:9px;cursor:pointer;font-weight:700;box-shadow:0 5px 16px rgba(0,123,255,0.13);border:none;" onclick="location.reload()">Restart Quiz</button>
      </div>
    `);
  }

  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  $(document).ready(function () {
    const quizDataUrl = "https://dineshbusireddy.github.io/tutorial/questions.json";
    $.getJSON(quizDataUrl)
      .done(function (data) {
        chapters = data;
        renderChapterList();

        const chapterParam = getQueryParam("chapter");
        const maxQuestionsParam = getQueryParam("maxQuestions");
        if (maxQuestionsParam && !isNaN(maxQuestionsParam) && Number(maxQuestionsParam) > 0) {
          MAX_QUESTIONS = Number(maxQuestionsParam);
        }

        if (chapterParam && (chapterParam === "all" || chapters.hasOwnProperty(chapterParam))) {
          selectedChapter = chapterParam;
          timerEnabled = false;
          timerDuration = 120;
          $("#timer-enable-slider").prop("checked", timerEnabled);
          $("#timer-duration-select").val(timerDuration.toString());
          updateTimerSettingsVisibility();

          // Show chapter intro card with start button instead of immediate start
          $("#chapter-select").hide();
          $("#progress-bar, #nav-bar, #pagination-controls, #question-page, #action-buttons, #scoreboard").hide();

          let displayName = (chapterParam === 'all') ? 'All Chapters' : chapterParam;
          let count = (chapterParam === 'all')
            ? Object.values(chapters).reduce((sum, arr) => sum + arr.length, 0)
            : chapters[chapterParam].length;
          $("#chapter-title").text(displayName + " Quiz");
          $("#chapter-question-count").text(count + " questions");
          $("#chapter-intro").show();

          $("#start-chapter-btn").off("click").on("click", function() {
            $("#chapter-intro").hide();
            startQuiz(selectedChapter);
          });
        } else {
          $("#progress-bar, #nav-bar, #pagination-controls, #question-page, #action-buttons, #scoreboard, #chapter-intro").hide();
          $("#chapter-select").show();
        }
      })
      .fail(function (jqxhr, textStatus, error) {
        $("#chapter-select").html(`<div style="color:red;">Failed to load quiz data: ${textStatus} - ${error}</div>`);
      });

    $("#timer-enable-slider").on("change", function () {
      if (selectedChapter !== "") {
        $(this).prop("checked", timerEnabled);
        return;
      }
      timerEnabled = $(this).prop("checked");
      updateTimerSettingsVisibility();
    });
    $("#timer-duration-select").on("change", function () {
      timerDuration = parseInt($(this).val(), 10);
    });

    function updateTimerSettingsVisibility() {
      if (timerEnabled) {
        $("#timer-duration-label, #timer-duration-select").show();
        $("#max-questions-select").prop("disabled", !!selectedChapter);
        $("#timer-duration-select").prop("disabled", !!selectedChapter);
      } else {
        $("#timer-duration-label, #timer-duration-select").hide();
        $("#max-questions-select").prop("disabled", !!selectedChapter);
        $("#timer-duration-select").prop("disabled", true);
      }
    }

    $("#settings-icon").on("click", () => {
      $("#max-questions-select").val(MAX_QUESTIONS.toString());
      $("#page-size-select").val(PAGE_SIZE.toString());
      $("#timer-enable-slider").prop("checked", timerEnabled);
      $("#timer-duration-select").val(timerDuration.toString());
      updateTimerSettingsVisibility();
      $("#max-questions-select").prop("disabled", selectedChapter !== "");
      $("#timer-enable-slider").prop("disabled", selectedChapter !== "");
      $("#timer-duration-select").prop("disabled", selectedChapter !== "");
      $("#settings-modal").css("display", "flex");
    });

    $("#settings-cancel-btn").on("click", () => { $("#settings-modal").hide(); });

    $("#settings-save-btn").on("click", () => {
      let newMaxQ = parseInt($("#max-questions-select").val(), 10);
      let newPageS = parseInt($("#page-size-select").val(), 10);
      let newTimerEnabled = $("#timer-enable-slider").prop("checked");
      let newTimerDuration = parseInt($("#timer-duration-select").val(), 10);
      if (!selectedChapter) {
        MAX_QUESTIONS = newMaxQ;
        timerEnabled = newTimerEnabled;
        timerDuration = newTimerDuration;
      }
      PAGE_SIZE = newPageS;
      $("#settings-modal").hide();
      if (selectedChapter) {
        currentPage = Math.floor(currentIndex / PAGE_SIZE);
        renderNavBarPage(currentPage);
        renderPaginationControls();
        renderQuestion(currentIndex);
        if (timerEnabled) {
          $("#timer-display").show();
          startTimer();
        } else {
          stopTimer();
          $("#timer-display").hide();
        }
      }
    });

    $("#home-icon").on("click", () => {
      selectedChapter = "";
      questions = [];
      answeredQuestions = [];
      wrongQuestions = [];
      currentIndex = 0;
      currentPage = 0;
      timerEnabled = false;
      stopTimer();
      $("#progress-bar, #nav-bar, #pagination-controls, #question-page, #action-buttons, #scoreboard, #chapter-intro").hide();
      $("#chapter-select").show();
      renderChapterList();
      $("#timer-display").hide();
    });
  });
</script>
</body>
</html>
